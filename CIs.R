library(RMySQL)
library(plotrix)
library(dplyr)

dir.create(paste("~/Temp_Graf_R/",sep=""),recursive = TRUE)

interval <- function(dataframe, attribute){
  meam <- mean(dataframe[,attribute])
  standardDerivation <- sd(dataframe[,attribute])
  standartError <- standardDerivation / sqrt(length(dataframe[,attribute]))
  tDistribution <- qt(0.975,df=length(dataframe[,attribute])-1)
  v_lower_ep <- meam - tDistribution*standartError
  v_upper_ep <- meam + tDistribution*standartError
  
  data<-NULL
  data$mean <- meam
  data$lower <- v_lower_ep
  data$upper <- v_upper_ep
  return(data)
}

#projects <- c("derby","tomcat","glibc","httpd","xen","kernel","mozilla")
projects <- c("derby","glibc")
metrics <- c("CountInput","CountLine","CountLineBlank","CountLineCode","CountLineCodeDecl","CountLineCodeExe","CountLineComment","CountOutput","CountPath","CountSemicolon","CountStmt","CountStmtDecl","CountStmtExe","Cyclomatic","CyclomaticModified","CyclomaticStrict","Essential","Knots","MaxEssentialKnots","MaxNesting","MinEssentialKnots","RatioCommentToCode")

CIs <- NULL

for(project in projects){
  con <- dbConnect(MySQL(), user = 'root', password = 'admin', host = 'localhost', dbname='software')
  vulnerable_query <- paste("SELECT * FROM software.FUNCTIONS_",project," where Affected=1;",sep = "")
  neutral_query <- paste("SELECT * FROM software.FUNCTIONS_",project," where Affected=0;",sep = "")
  vulnerable_table_frame <- dbGetQuery(con,vulnerable_query)
  neutral_table_frame <- dbGetQuery(con,neutral_query)
  dbDisconnect(con)
  
  vulnerable_table_frame <- subset(vulnerable_table_frame, select = metrics)
  neutral_table_frame <- subset(neutral_table_frame, select = metrics)
  
  for(metric in metrics){
    vulnerable_interval <- interval(vulnerable_table_frame, metric)
    neutral_interval <- interval(neutral_table_frame, metric)
    
    index <- paste(project,metric,"vulnerable",sep="_")
    CIs <- rbind_list(CIs, c(index,vulnerable_interval))
    index <- paste(project,metric,"neutral",sep="_")
    CIs <- rbind_list(CIs, c(index,neutral_interval))
  }
}
colnames(CIs) <- c("index","mean","lower","upper")

#title=paste(metric,"ci", sep="_")
#path_image=paste("~/Temp_Graf_R/",title,".pdf",sep="")
#pdf(path_image)#,width = 390, height = 290

#xtam = c(0,4)
#ytam = c(0,2)
#plotCI(x=1, y=vulnerable_interval$mean, col="darkgrey",li=vulnerable_interval$lower,ui=vulnerable_interval$upper, xlim=xtam, ylim=ytam)

#par(new=TRUE)

#plotCI(x=1,y=neutral_interval$mean,li=neutral_interval$lower,ui=neutral_interval$upper,lwd=3, axes=FALSE, ann=FALSE,xlim=xtam, ylim=ytam)

#grid()
#dev.off()