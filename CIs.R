library(RMySQL)
library(plotrix)
library(dplyr)

dir.create(paste("~/Temp_Graf_R/",sep=""),recursive = TRUE)

interval <- function(dataframe, attribute){
  meam <- mean(dataframe[,attribute])
  standardDerivation <- sd(dataframe[,attribute])
  standartError <- standardDerivation / sqrt(length(dataframe[,attribute]))
  tDistribution <- qt(0.975,df=length(dataframe[,attribute])-1)
  v_lower_ep <- meam - tDistribution*standartError
  v_upper_ep <- meam + tDistribution*standartError
  
  data<-NULL
  data$mean <- meam
  data$lower <- v_lower_ep
  data$upper <- v_upper_ep
  return(data)
}

projects <- c("derby","tomcat","glibc","httpd","xen","kernel","mozilla")
metrics <- c("CountInput","CountLine","CountLineBlank","CountLineCode","CountLineCodeDecl","CountLineCodeExe","CountLineComment","CountOutput","CountPath","CountSemicolon","CountStmt","CountStmtDecl","CountStmtExe","Cyclomatic","CyclomaticModified","CyclomaticStrict","Essential","Knots","MaxEssentialKnots","MaxNesting","MinEssentialKnots","RatioCommentToCode")

CIs <- NULL

for(project in projects){
  con <- dbConnect(MySQL(), user = 'root', password = 'admin', host = 'localhost', dbname='software')
  vulnerable_query <- paste("SELECT * FROM software.FUNCTIONS_affected_",project,sep = "")
  neutral_query <- paste("SELECT * FROM software.FUNCTIONS_neutral_",project,sep = "")
  print(vulnerable_query)
  vulnerable_table_frame <- dbGetQuery(con,vulnerable_query)
  print(neutral_query)
  neutral_table_frame <- dbGetQuery(con,neutral_query)
  dbDisconnect(con)
  
  vulnerable_table_frame <- subset(vulnerable_table_frame, select = metrics)
  neutral_table_frame <- subset(neutral_table_frame, select = metrics)
  
  for(metric in metrics){
    vulnerable_interval <- interval(vulnerable_table_frame, metric)
    neutral_interval <- interval(neutral_table_frame, metric)
    
    CIs <- rbind(CIs, c(project,metric,"vulnerable",vulnerable_interval))
    CIs <- rbind(CIs, c(project,metric,"neutral",neutral_interval))
  }
}

colnames(CIs) <- c("project","metric","classifier","mean","lower","upper")
CIs <- data.frame(CIs)

vulnerable_table_frame <- NULL
neutral_table_frame<-NULL

for(metric in metrics){
  title=paste(metric,"ci", sep="_")
  path_image=paste("~/Temp_Graf_R/",title,".pdf",sep="")
  pdf(path_image)#,width = 390, height = 290
  
  CIs_metric <- CIs[CIs$metric==metric,]
  
  size_extra<-(max(data.frame(CIs_metric$upper))-min(data.frame(CIs_metric$lower)))/4
  ytam<-c(min(data.frame(CIs_metric$lower))-size_extra,max(data.frame(CIs_metric$upper))+size_extra)
  xtam = c(1,length(projects))
  
  ci_padrao<-(ytam[2]+ytam[1])/2;
  
  plotCI(x=1, y=ci_padrao, col="darkgrey",li=ci_padrao,ui=ci_padrao, xlim=xtam, ylim=ytam,
         lwd=0.2,
         xlab="",
         ylab="",
         xaxt="n",
         cex.lab=1.4,
         cex.axis=1.4)
  
  for(i in 1:(length(projects))){
    project<-projects[i]

    vulnerable_interval=data.frame(CIs_metric[CIs_metric$project==project & CIs_metric$classifier=="vulnerable",])
    par(new=TRUE)
    plotCI(x=i,y=vulnerable_interval$mean[[1]],col="darkgrey",li=vulnerable_interval$lower[[1]],ui=vulnerable_interval$upper[[1]],lwd=3, axes=FALSE, ann=FALSE,xlim=xtam, ylim=ytam)
    
    neutral_interval=data.frame(CIs_metric[CIs_metric$project==project & CIs_metric$classifier=="neutral",])
    par(new=TRUE)
    plotCI(x=i,y=neutral_interval$mean[[1]],li=neutral_interval$lower[[1]],ui=neutral_interval$upper[[1]],lwd=3, axes=FALSE, ann=FALSE,xlim=xtam, ylim=ytam)
    
  }
  
  axis(side=1, at=1:length(projects), labels=projects,cex.axis=1.4)
  
  legend("topleft", xpd=TRUE, ncol=2, legend=c("V", "N"),
         fill=c("grey", "black"), bty="n",cex=1.5)
  
  grid()
  dev.off()
  
}