library(RMySQL)
library(caret)
require(randomForest)

projects<-c('glibc','httpd','xen','derby','tomcat','kernel','mozilla')

path<-"/home/rique/Temp_Results_R/importance/"
dir.create(path,recursive = TRUE)
setwd(path)

metrics <- c("CountLine","CountLineCode","CountLineCodeExe","CountLineCodeDecl","CountLineBlank","CountStmt","CountStmtExe","CountStmtDecl","Cyclomatic","CyclomaticModified","CyclomaticStrict","CountSemicolon","MaxNesting","Knots","Essential","MaxEssentialKnots","MinEssentialKnots","CountPath","CountLineComment","RatioCommentToCode","CountInput","CountOutput","Affected")

output <- data.frame(row.names = data.frame(metrics)[1:22,])
for(project in projects){
  
  con <- dbConnect(MySQL(), user = 'root', password = 'admin', host = '127.0.0.1', dbname='software')
  df <- dbGetQuery(con, paste("SELECT * FROM software.FUNCTIONS_neutral_",project,sep = ''))
  df <- rbind(df,dbGetQuery(con, paste("SELECT * FROM software.FUNCTIONS_affected_",project,sep = '')))
  df <- subset(df, select = metrics)
  dbDisconnect(con)
  
  #fit=randomForest(Affected~., data=df, ntree=10, importance=TRUE)
  #importance <- varImp(fit)
  
  df$Affected <- factor(ifelse(df$Affected == 0,"NEUTRAL","VULNERABLE"))
  control <- trainControl(method="repeatedcv", number=10, repeats=3)
  model <- train(Affected~.,data=df, method="lvq", preProcess="scale", trControl=control, na.action = na.pass)
  importance <- varImp(model, scale=FALSE)

  output[,project] <- importance$Overall
}

output$total <- output$glibc+output$httpd+output$xen+output$derby+output$tomcat+output$kernel+output$mozilla
write.csv(output, paste(path,"importance3",".csv",sep = ''))