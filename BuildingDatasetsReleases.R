library(RMySQL)
library(foreign)

exportReleases <- function(metrics,releases,project,path){
  for(release in releases){
    con <- dbConnect(MySQL(), user = 'root', password = 'admin', host = '127.0.0.1', dbname='software')
    
    vulnerable_query <- paste("SELECT distinct F.* FROM software.FILES_affected_",project," AS F, software.PATCHES AS P, software.EXTRA_TIME_FILES as T where F.ID_File = T.ID_File AND T.P_ID = P.P_ID AND P.RELEASES LIKE '%",release,"%';",sep = "")
    neutral_query <- paste("SELECT distinct F.* FROM software.FILES_neutral_",project," AS F, software.PATCHES AS P, software.EXTRA_TIME_FILES as T where F.ID_File = T.ID_File AND T.P_ID = P.P_ID AND P.RELEASES LIKE '%",release,"%';",sep = "")
    
    print(vulnerable_query)
    vulnerable_table_frame <- dbGetQuery(con,vulnerable_query)
    
    print(neutral_query)
    neutral_table_frame <- dbGetQuery(con,neutral_query)
    
    dbDisconnect(con)
    
    all <- rbind(vulnerable_table_frame,neutral_table_frame)
    all$CountDeclFunction <- all$CountDeclMethod
    all$CountLinePreprocessor <- 0
    
    all <- subset(all,select = metrics)
    all$Affected <- factor(ifelse(all$Affected == 0,"NEUTRAL","VULNERABLE"))
    
    write.arff(all, paste(path,release,".arff",sep = ''))
  }
}

project <- "tomcat"
releases <- c("6.0.44","6.0.45","6.0.46","6.0.48","6.0.49","7.0.21","7.0.22","7.0.23","7.0.30","7.0.32","7.0.33","7.0.40","7.0.43","7.0.48","7.0.51","7.0.53","7.0.54","7.0.55","7.0.58","7.0.65","7.0.66","7.0.68","7.0.70","7.0.71","7.0.73","7.0.74","8.0.9","8.0.16","8.0.27","8.0.30","8.0.31","8.0.39","8.0.40","8.5.3","8.5.5","8.5.7","8.5.9")

path <- "~/DatasetsComparableTechiniques/Evaluating Complexity, Code Churn, and _Developer Activity Metrics as Indicators _of Software Vulnerabilities/"
metrics <- c("CountLineCode","CountDeclFunction","CountLineCodeDecl","CountLinePreprocessor","SumEssential","SumCyclomaticStrict","SumMaxNesting","MaxCyclomaticStrict","MaxMaxNesting","FanIn","FanOut","MaxFanIn","MaxFanOut","RatioCommentToCode","Affected")
exportReleases(metrics,releases,project,path)

path <- "~/DatasetsComparableTechiniques/Exploring Complexity Metrics as Indicators _of Software Vulnerability/"
metrics <- c("SumCyclomatic","SumCyclomaticModified","SumCyclomaticStrict","SumEssential","MaxNesting","CountLineCode","CountStmt","CountLineCodeExe","Affected")
exportReleases(metrics,releases,project,path)