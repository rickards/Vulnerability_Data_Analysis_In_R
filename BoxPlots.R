library(RMySQL)
library(plotrix)

metrics <- c("AltCountLineCode","CountInput","CountLineBlank","CountLineCodeDecl","CountLineComment","CountLinePreprocessor","CountPath","CountStmt","CountStmtEmpty","Cyclomatic","CyclomaticStrict","Knots","MinEssentialKnots","RatioCommentToCode","AltCountLineComment","CountLine","CountLineCode","CountLineCodeExe","CountLineInactive","CountOutput","CountSemicolon","CountStmtDecl","CountStmtExe","CyclomaticModified","Essential","MaxEssentialKnots","MaxNesting")

dir.create(paste("/home/rique/Temp_Graf_R/",sep=""),recursive = TRUE)
for(metric in metrics){
  
  modules_rid_n <- c("FUNCTIONS_4_tools","FUNCTIONS_4_xen")
  print("~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~Pull Database R_ID=4~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~")
  table = "FUNCTIONS_4_arch"
  query_vul <- paste("select xd.",metric," from (
                     SELECT DISTINCT tb.FilePath,tb.NameMethod,tb.AltCountLineCode,
                     tb.CountInput,tb.CountLineBlank,tb.CountLineCodeDecl,
                     tb.CountLineComment,tb.CountLinePreprocessor,tb.CountPath,
                     tb.CountStmt,tb.CountStmtEmpty,tb.Cyclomatic,tb.CyclomaticStrict,
                     tb.Knots,tb.MinEssentialKnots,tb.RatioCommentToCode,
                     tb.AltCountLineComment,tb.CountLine,tb.CountLineCode,
                     tb.CountLineCodeExe,tb.CountLineInactive,tb.CountOutput,
                     tb.CountSemicolon,tb.CountStmtDecl,tb.CountStmtExe,
                     tb.CyclomaticModified,tb.Essential,tb.MaxEssentialKnots,
                     tb.MaxNesting FROM ",table," tb where Patched=1 and Occurrence='before'
  ) xd;",sep="")
  query_no_vul <- paste("SELECT ",metric," FROM ",table," f2s WHERE f2s.ID_Function NOT IN (SELECT distinct tb.ID_Function FROM ",table," tb, (SELECT * FROM ",table," WHERE patched=1 AND Occurrence='before') vul WHERE tb.FilePath=vul.FilePath AND tb.NameMethod=vul.NameMethod AND tb.AltCountLineCode=vul.AltCountLineCode AND tb.CountInput=vul.CountInput AND tb.CountLineBlank=vul.CountLineBlank AND tb.CountLineCodeDecl=vul.CountLineCodeDecl AND tb.CountLineComment=vul.CountLineComment AND tb.CountLinePreprocessor=vul.CountLinePreprocessor AND tb.CountPath=vul.CountPath AND tb.CountStmt=vul.CountStmt AND tb.CountStmtEmpty=vul.CountStmtEmpty AND tb.Cyclomatic=vul.Cyclomatic AND tb.CyclomaticStrict=vul.CyclomaticStrict AND tb.Knots=vul.Knots AND tb.MinEssentialKnots=vul.MinEssentialKnots AND tb.RatioCommentToCode=vul.RatioCommentToCode AND tb.AltCountLineComment=vul.AltCountLineComment AND tb.CountLine=vul.CountLine AND tb.CountLineCode=vul.CountLineCode AND tb.CountLineCodeExe=vul.CountLineCodeExe AND tb.CountLineInactive=vul.CountLineInactive AND tb.CountOutput=vul.CountOutput AND tb.CountSemicolon=vul.CountSemicolon AND tb.CountStmtDecl=vul.CountStmtDecl AND tb.CountStmtExe=vul.CountStmtExe AND tb.CyclomaticModified=vul.CyclomaticModified AND tb.Essential=vul.Essential AND tb.MaxEssentialKnots=vul.MaxEssentialKnots AND tb.MaxNesting=vul.MaxNesting);",sep="")
  
  con <- dbConnect(MySQL(), user = 'root', password = 'admin', host = 'localhost', dbname='security')
  modules_rid_n_vul4 <- dbGetQuery(con,query_vul)
  modules_rid_n_no_vul4 <- dbGetQuery(con,query_no_vul)
  dbDisconnect(con)
  
  for (table in modules_rid_n) {
    query_vul <- paste("select xd.",metric," from (
                       SELECT DISTINCT tb.FilePath,tb.NameMethod,tb.AltCountLineCode,
                       tb.CountInput,tb.CountLineBlank,tb.CountLineCodeDecl,
                       tb.CountLineComment,tb.CountLinePreprocessor,tb.CountPath,
                       tb.CountStmt,tb.CountStmtEmpty,tb.Cyclomatic,tb.CyclomaticStrict,
                       tb.Knots,tb.MinEssentialKnots,tb.RatioCommentToCode,
                       tb.AltCountLineComment,tb.CountLine,tb.CountLineCode,
                       tb.CountLineCodeExe,tb.CountLineInactive,tb.CountOutput,
                       tb.CountSemicolon,tb.CountStmtDecl,tb.CountStmtExe,
                       tb.CyclomaticModified,tb.Essential,tb.MaxEssentialKnots,
                       tb.MaxNesting FROM ",table," tb where Patched=1 and Occurrence='before'
    ) xd;",sep="")
    query_no_vul <- paste("SELECT ",metric," FROM ",table," f2s WHERE f2s.ID_Function NOT IN (SELECT distinct tb.ID_Function FROM ",table," tb, (SELECT * FROM ",table," WHERE patched=1 AND Occurrence='before') vul WHERE tb.FilePath=vul.FilePath AND tb.NameMethod=vul.NameMethod AND tb.AltCountLineCode=vul.AltCountLineCode AND tb.CountInput=vul.CountInput AND tb.CountLineBlank=vul.CountLineBlank AND tb.CountLineCodeDecl=vul.CountLineCodeDecl AND tb.CountLineComment=vul.CountLineComment AND tb.CountLinePreprocessor=vul.CountLinePreprocessor AND tb.CountPath=vul.CountPath AND tb.CountStmt=vul.CountStmt AND tb.CountStmtEmpty=vul.CountStmtEmpty AND tb.Cyclomatic=vul.Cyclomatic AND tb.CyclomaticStrict=vul.CyclomaticStrict AND tb.Knots=vul.Knots AND tb.MinEssentialKnots=vul.MinEssentialKnots AND tb.RatioCommentToCode=vul.RatioCommentToCode AND tb.AltCountLineComment=vul.AltCountLineComment AND tb.CountLine=vul.CountLine AND tb.CountLineCode=vul.CountLineCode AND tb.CountLineCodeExe=vul.CountLineCodeExe AND tb.CountLineInactive=vul.CountLineInactive AND tb.CountOutput=vul.CountOutput AND tb.CountSemicolon=vul.CountSemicolon AND tb.CountStmtDecl=vul.CountStmtDecl AND tb.CountStmtExe=vul.CountStmtExe AND tb.CyclomaticModified=vul.CyclomaticModified AND tb.Essential=vul.Essential AND tb.MaxEssentialKnots=vul.MaxEssentialKnots AND tb.MaxNesting=vul.MaxNesting);",sep="")
    
    
    con <- dbConnect(MySQL(), user = 'root', password = 'admin', host = 'localhost', dbname='security')
    functions_vul <- dbGetQuery(con,query_vul)
    functions_no_vul <- dbGetQuery(con,query_no_vul)
    dbDisconnect(con)
    
    modules_rid_n_vul4 <- rbind(modules_rid_n_vul4,functions_vul)
    modules_rid_n_no_vul4 <- rbind(modules_rid_n_no_vul4,functions_no_vul)
    
  }
  
  v_m4 <- mean(modules_rid_n_vul4[,metric])
  s <- sd(modules_rid_n_vul4[,metric])
  se <- s / sqrt(length(modules_rid_n_vul4[,metric]))
  cv <- qt(0.975,df=length(modules_rid_n_vul4[,metric])-1)
  v_lower_ep4 <- v_m4 - cv*se
  v_upper_ep4 <- v_m4 + cv*se
  n_m4 <- mean(modules_rid_n_no_vul4[,metric])
  s <- sd(modules_rid_n_no_vul4[,metric])
  se <- s / sqrt(length(modules_rid_n_no_vul4[,metric]))
  cv <- qt(0.975,df=length(modules_rid_n_no_vul4[,metric])-1)
  n_lower_ep4 <- n_m4 - cv*se
  n_upper_ep4 <- n_m4 + cv*se
  
  print("~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~Pull Database R_ID=6~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~")
  
  modules_rid_n <- c()
  
  table = "FUNCTIONS_6_apache"
  query_vul <- paste("select xd.",metric," from (
                     SELECT DISTINCT tb.FilePath,tb.NameMethod,tb.AltCountLineCode,
                     tb.CountInput,tb.CountLineBlank,tb.CountLineCodeDecl,
                     tb.CountLineComment,tb.CountLinePreprocessor,tb.CountPath,
                     tb.CountStmt,tb.CountStmtEmpty,tb.Cyclomatic,tb.CyclomaticStrict,
                     tb.Knots,tb.MinEssentialKnots,tb.RatioCommentToCode,
                     tb.AltCountLineComment,tb.CountLine,tb.CountLineCode,
                     tb.CountLineCodeExe,tb.CountLineInactive,tb.CountOutput,
                     tb.CountSemicolon,tb.CountStmtDecl,tb.CountStmtExe,
                     tb.CyclomaticModified,tb.Essential,tb.MaxEssentialKnots,
                     tb.MaxNesting FROM ",table," tb where Patched=1 and Occurrence='before'
  ) xd;",sep="")
  query_no_vul <- paste("SELECT ",metric," FROM ",table," f2s WHERE f2s.ID_Function NOT IN (SELECT distinct tb.ID_Function FROM ",table," tb, (SELECT * FROM ",table," WHERE patched=1 AND Occurrence='before') vul WHERE tb.FilePath=vul.FilePath AND tb.NameMethod=vul.NameMethod AND tb.AltCountLineCode=vul.AltCountLineCode AND tb.CountInput=vul.CountInput AND tb.CountLineBlank=vul.CountLineBlank AND tb.CountLineCodeDecl=vul.CountLineCodeDecl AND tb.CountLineComment=vul.CountLineComment AND tb.CountLinePreprocessor=vul.CountLinePreprocessor AND tb.CountPath=vul.CountPath AND tb.CountStmt=vul.CountStmt AND tb.CountStmtEmpty=vul.CountStmtEmpty AND tb.Cyclomatic=vul.Cyclomatic AND tb.CyclomaticStrict=vul.CyclomaticStrict AND tb.Knots=vul.Knots AND tb.MinEssentialKnots=vul.MinEssentialKnots AND tb.RatioCommentToCode=vul.RatioCommentToCode AND tb.AltCountLineComment=vul.AltCountLineComment AND tb.CountLine=vul.CountLine AND tb.CountLineCode=vul.CountLineCode AND tb.CountLineCodeExe=vul.CountLineCodeExe AND tb.CountLineInactive=vul.CountLineInactive AND tb.CountOutput=vul.CountOutput AND tb.CountSemicolon=vul.CountSemicolon AND tb.CountStmtDecl=vul.CountStmtDecl AND tb.CountStmtExe=vul.CountStmtExe AND tb.CyclomaticModified=vul.CyclomaticModified AND tb.Essential=vul.Essential AND tb.MaxEssentialKnots=vul.MaxEssentialKnots AND tb.MaxNesting=vul.MaxNesting);",sep="")
  
  con <- dbConnect(MySQL(), user = 'root', password = 'admin', host = 'localhost', dbname='security')
  modules_rid_n_vul6 <- dbGetQuery(con,query_vul)
  modules_rid_n_no_vul6 <- dbGetQuery(con,query_no_vul)
  dbDisconnect(con)
  
  for (table in modules_rid_n) {
    query_vul <- paste("select xd.",metric," from (
                       SELECT DISTINCT tb.FilePath,tb.NameMethod,tb.AltCountLineCode,
                       tb.CountInput,tb.CountLineBlank,tb.CountLineCodeDecl,
                       tb.CountLineComment,tb.CountLinePreprocessor,tb.CountPath,
                       tb.CountStmt,tb.CountStmtEmpty,tb.Cyclomatic,tb.CyclomaticStrict,
                       tb.Knots,tb.MinEssentialKnots,tb.RatioCommentToCode,
                       tb.AltCountLineComment,tb.CountLine,tb.CountLineCode,
                       tb.CountLineCodeExe,tb.CountLineInactive,tb.CountOutput,
                       tb.CountSemicolon,tb.CountStmtDecl,tb.CountStmtExe,
                       tb.CyclomaticModified,tb.Essential,tb.MaxEssentialKnots,
                       tb.MaxNesting FROM ",table," tb where Patched=1 and Occurrence='before'
    ) xd;",sep="")
    query_no_vul <- paste("SELECT ",metric," FROM ",table," f2s WHERE f2s.ID_Function NOT IN (SELECT distinct tb.ID_Function FROM ",table," tb, (SELECT * FROM ",table," WHERE patched=1 AND Occurrence='before') vul WHERE tb.FilePath=vul.FilePath AND tb.NameMethod=vul.NameMethod AND tb.AltCountLineCode=vul.AltCountLineCode AND tb.CountInput=vul.CountInput AND tb.CountLineBlank=vul.CountLineBlank AND tb.CountLineCodeDecl=vul.CountLineCodeDecl AND tb.CountLineComment=vul.CountLineComment AND tb.CountLinePreprocessor=vul.CountLinePreprocessor AND tb.CountPath=vul.CountPath AND tb.CountStmt=vul.CountStmt AND tb.CountStmtEmpty=vul.CountStmtEmpty AND tb.Cyclomatic=vul.Cyclomatic AND tb.CyclomaticStrict=vul.CyclomaticStrict AND tb.Knots=vul.Knots AND tb.MinEssentialKnots=vul.MinEssentialKnots AND tb.RatioCommentToCode=vul.RatioCommentToCode AND tb.AltCountLineComment=vul.AltCountLineComment AND tb.CountLine=vul.CountLine AND tb.CountLineCode=vul.CountLineCode AND tb.CountLineCodeExe=vul.CountLineCodeExe AND tb.CountLineInactive=vul.CountLineInactive AND tb.CountOutput=vul.CountOutput AND tb.CountSemicolon=vul.CountSemicolon AND tb.CountStmtDecl=vul.CountStmtDecl AND tb.CountStmtExe=vul.CountStmtExe AND tb.CyclomaticModified=vul.CyclomaticModified AND tb.Essential=vul.Essential AND tb.MaxEssentialKnots=vul.MaxEssentialKnots AND tb.MaxNesting=vul.MaxNesting);",sep="")
    
    
    con <- dbConnect(MySQL(), user = 'root', password = 'admin', host = 'localhost', dbname='security')
    functions_vul <- dbGetQuery(con,query_vul)
    functions_no_vul <- dbGetQuery(con,query_no_vul)
    dbDisconnect(con)
    
    modules_rid_n_vul6 <- rbind(modules_rid_n_vul6,functions_vul)
    modules_rid_n_no_vul6 <- rbind(modules_rid_n_no_vul6,functions_no_vul)
  }
  
  v_m6 <- mean(modules_rid_n_vul6[,metric])
  s <- sd(modules_rid_n_vul6[,metric])
  se <- s / sqrt(length(modules_rid_n_vul6[,metric]))
  cv <- qt(0.975,df=length(modules_rid_n_vul6[,metric])-1)
  v_lower_ep6 <- v_m6 - cv*se
  v_upper_ep6 <- v_m6 + cv*se
  n_m6 <- mean(modules_rid_n_no_vul6[,metric])
  s <- sd(modules_rid_n_no_vul6[,metric])
  se <- s / sqrt(length(modules_rid_n_no_vul6[,metric]))
  cv <- qt(0.975,df=length(modules_rid_n_no_vul6[,metric])-1)
  n_lower_ep6 <- n_m6 - cv*se
  n_upper_ep6 <- n_m6 + cv*se
  
  print("~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~Pull Database R_ID=7~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~")
  
  modules_rid_n <- c()
  
  table = "FUNCTIONS_7_glibc"
  query_vul <- paste("select xd.",metric," from (
                     SELECT DISTINCT tb.FilePath,tb.NameMethod,tb.AltCountLineCode,
                     tb.CountInput,tb.CountLineBlank,tb.CountLineCodeDecl,
                     tb.CountLineComment,tb.CountLinePreprocessor,tb.CountPath,
                     tb.CountStmt,tb.CountStmtEmpty,tb.Cyclomatic,tb.CyclomaticStrict,
                     tb.Knots,tb.MinEssentialKnots,tb.RatioCommentToCode,
                     tb.AltCountLineComment,tb.CountLine,tb.CountLineCode,
                     tb.CountLineCodeExe,tb.CountLineInactive,tb.CountOutput,
                     tb.CountSemicolon,tb.CountStmtDecl,tb.CountStmtExe,
                     tb.CyclomaticModified,tb.Essential,tb.MaxEssentialKnots,
                     tb.MaxNesting FROM ",table," tb where Patched=1 and Occurrence='before'
  ) xd;",sep="")
  query_no_vul <- paste("SELECT ",metric," FROM ",table," f2s WHERE f2s.ID_Function NOT IN (SELECT distinct tb.ID_Function FROM ",table," tb, (SELECT * FROM ",table," WHERE patched=1 AND Occurrence='before') vul WHERE tb.FilePath=vul.FilePath AND tb.NameMethod=vul.NameMethod AND tb.AltCountLineCode=vul.AltCountLineCode AND tb.CountInput=vul.CountInput AND tb.CountLineBlank=vul.CountLineBlank AND tb.CountLineCodeDecl=vul.CountLineCodeDecl AND tb.CountLineComment=vul.CountLineComment AND tb.CountLinePreprocessor=vul.CountLinePreprocessor AND tb.CountPath=vul.CountPath AND tb.CountStmt=vul.CountStmt AND tb.CountStmtEmpty=vul.CountStmtEmpty AND tb.Cyclomatic=vul.Cyclomatic AND tb.CyclomaticStrict=vul.CyclomaticStrict AND tb.Knots=vul.Knots AND tb.MinEssentialKnots=vul.MinEssentialKnots AND tb.RatioCommentToCode=vul.RatioCommentToCode AND tb.AltCountLineComment=vul.AltCountLineComment AND tb.CountLine=vul.CountLine AND tb.CountLineCode=vul.CountLineCode AND tb.CountLineCodeExe=vul.CountLineCodeExe AND tb.CountLineInactive=vul.CountLineInactive AND tb.CountOutput=vul.CountOutput AND tb.CountSemicolon=vul.CountSemicolon AND tb.CountStmtDecl=vul.CountStmtDecl AND tb.CountStmtExe=vul.CountStmtExe AND tb.CyclomaticModified=vul.CyclomaticModified AND tb.Essential=vul.Essential AND tb.MaxEssentialKnots=vul.MaxEssentialKnots AND tb.MaxNesting=vul.MaxNesting);",sep="")
  
  con <- dbConnect(MySQL(), user = 'root', password = 'admin', host = 'localhost', dbname='security')
  modules_rid_n_vul7 <- dbGetQuery(con,query_vul)
  modules_rid_n_no_vul7 <- dbGetQuery(con,query_no_vul)
  dbDisconnect(con)
  
  for (table in modules_rid_n) {
    query_vul <- paste("select xd.",metric," from (
                       SELECT DISTINCT tb.FilePath,tb.NameMethod,tb.AltCountLineCode,
                       tb.CountInput,tb.CountLineBlank,tb.CountLineCodeDecl,
                       tb.CountLineComment,tb.CountLinePreprocessor,tb.CountPath,
                       tb.CountStmt,tb.CountStmtEmpty,tb.Cyclomatic,tb.CyclomaticStrict,
                       tb.Knots,tb.MinEssentialKnots,tb.RatioCommentToCode,
                       tb.AltCountLineComment,tb.CountLine,tb.CountLineCode,
                       tb.CountLineCodeExe,tb.CountLineInactive,tb.CountOutput,
                       tb.CountSemicolon,tb.CountStmtDecl,tb.CountStmtExe,
                       tb.CyclomaticModified,tb.Essential,tb.MaxEssentialKnots,
                       tb.MaxNesting FROM ",table," tb where Patched=1 and Occurrence='before'
    ) xd;",sep="")
    query_no_vul <- paste("SELECT ",metric," FROM ",table," f2s WHERE f2s.ID_Function NOT IN (SELECT distinct tb.ID_Function FROM ",table," tb, (SELECT * FROM ",table," WHERE patched=1 AND Occurrence='before') vul WHERE tb.FilePath=vul.FilePath AND tb.NameMethod=vul.NameMethod AND tb.AltCountLineCode=vul.AltCountLineCode AND tb.CountInput=vul.CountInput AND tb.CountLineBlank=vul.CountLineBlank AND tb.CountLineCodeDecl=vul.CountLineCodeDecl AND tb.CountLineComment=vul.CountLineComment AND tb.CountLinePreprocessor=vul.CountLinePreprocessor AND tb.CountPath=vul.CountPath AND tb.CountStmt=vul.CountStmt AND tb.CountStmtEmpty=vul.CountStmtEmpty AND tb.Cyclomatic=vul.Cyclomatic AND tb.CyclomaticStrict=vul.CyclomaticStrict AND tb.Knots=vul.Knots AND tb.MinEssentialKnots=vul.MinEssentialKnots AND tb.RatioCommentToCode=vul.RatioCommentToCode AND tb.AltCountLineComment=vul.AltCountLineComment AND tb.CountLine=vul.CountLine AND tb.CountLineCode=vul.CountLineCode AND tb.CountLineCodeExe=vul.CountLineCodeExe AND tb.CountLineInactive=vul.CountLineInactive AND tb.CountOutput=vul.CountOutput AND tb.CountSemicolon=vul.CountSemicolon AND tb.CountStmtDecl=vul.CountStmtDecl AND tb.CountStmtExe=vul.CountStmtExe AND tb.CyclomaticModified=vul.CyclomaticModified AND tb.Essential=vul.Essential AND tb.MaxEssentialKnots=vul.MaxEssentialKnots AND tb.MaxNesting=vul.MaxNesting);",sep="")
    
    
    con <- dbConnect(MySQL(), user = 'root', password = 'admin', host = 'localhost', dbname='security')
    functions_vul <- dbGetQuery(con,query_vul)
    functions_no_vul <- dbGetQuery(con,query_no_vul)
    dbDisconnect(con)
    
    modules_rid_n_vul7 <- rbind(modules_rid_n_vul7,functions_vul)
    modules_rid_n_no_vul7 <- rbind(modules_rid_n_no_vul7,functions_no_vul)
  }
  
  v_m7 <- mean(modules_rid_n_vul7[,metric])
  s <- sd(modules_rid_n_vul7[,metric])
  se <- s / sqrt(length(modules_rid_n_vul7[,metric]))
  cv <- qt(0.975,df=length(modules_rid_n_vul7[,metric])-1)
  v_lower_ep7 <- v_m7 - cv*se
  v_upper_ep7 <- v_m7 + cv*se
  n_m7 <- mean(modules_rid_n_no_vul7[,metric])
  s <- sd(modules_rid_n_no_vul7[,metric])
  se <- s / sqrt(length(modules_rid_n_no_vul7[,metric]))
  cv <- qt(0.975,df=length(modules_rid_n_no_vul7[,metric])-1)
  n_lower_ep7 <- n_m7 - cv*se
  n_upper_ep7 <- n_m7 + cv*se
  
  print("~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~Pull Database R_ID=1~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~")
  modules_rid_n <- c("FUNCTIONS_1_javascript","FUNCTIONS_1_javascript_extras","FUNCTIONS_1_javascript_xpconnect","FUNCTIONS_1_layout_rendering","FUNCTIONS_1_libraries","FUNCTIONS_1_mozilla","FUNCTIONS_1_network","FUNCTIONS_1_toolkit","FUNCTIONS_1_webpage_structure","FUNCTIONS_1_widget")
  
  table = "FUNCTIONS_1_dom"
  query_vul <- paste("select xd.",metric," from (
                     SELECT DISTINCT tb.FilePath,tb.NameMethod,tb.AltCountLineCode,
                     tb.CountInput,tb.CountLineBlank,tb.CountLineCodeDecl,
                     tb.CountLineComment,tb.CountLinePreprocessor,tb.CountPath,
                     tb.CountStmt,tb.CountStmtEmpty,tb.Cyclomatic,tb.CyclomaticStrict,
                     tb.Knots,tb.MinEssentialKnots,tb.RatioCommentToCode,
                     tb.AltCountLineComment,tb.CountLine,tb.CountLineCode,
                     tb.CountLineCodeExe,tb.CountLineInactive,tb.CountOutput,
                     tb.CountSemicolon,tb.CountStmtDecl,tb.CountStmtExe,
                     tb.CyclomaticModified,tb.Essential,tb.MaxEssentialKnots,
                     tb.MaxNesting FROM ",table," tb where Patched=1 and Occurrence='before'
  ) xd;",sep="")
  query_no_vul <- paste("SELECT ",metric," FROM ",table," f2s WHERE f2s.ID_Function NOT IN (SELECT distinct tb.ID_Function FROM ",table," tb, (SELECT * FROM ",table," WHERE patched=1 AND Occurrence='before') vul WHERE tb.FilePath=vul.FilePath AND tb.NameMethod=vul.NameMethod AND tb.AltCountLineCode=vul.AltCountLineCode AND tb.CountInput=vul.CountInput AND tb.CountLineBlank=vul.CountLineBlank AND tb.CountLineCodeDecl=vul.CountLineCodeDecl AND tb.CountLineComment=vul.CountLineComment AND tb.CountLinePreprocessor=vul.CountLinePreprocessor AND tb.CountPath=vul.CountPath AND tb.CountStmt=vul.CountStmt AND tb.CountStmtEmpty=vul.CountStmtEmpty AND tb.Cyclomatic=vul.Cyclomatic AND tb.CyclomaticStrict=vul.CyclomaticStrict AND tb.Knots=vul.Knots AND tb.MinEssentialKnots=vul.MinEssentialKnots AND tb.RatioCommentToCode=vul.RatioCommentToCode AND tb.AltCountLineComment=vul.AltCountLineComment AND tb.CountLine=vul.CountLine AND tb.CountLineCode=vul.CountLineCode AND tb.CountLineCodeExe=vul.CountLineCodeExe AND tb.CountLineInactive=vul.CountLineInactive AND tb.CountOutput=vul.CountOutput AND tb.CountSemicolon=vul.CountSemicolon AND tb.CountStmtDecl=vul.CountStmtDecl AND tb.CountStmtExe=vul.CountStmtExe AND tb.CyclomaticModified=vul.CyclomaticModified AND tb.Essential=vul.Essential AND tb.MaxEssentialKnots=vul.MaxEssentialKnots AND tb.MaxNesting=vul.MaxNesting);",sep="")
  
  con <- dbConnect(MySQL(), user = 'root', password = 'admin', host = 'localhost', dbname='security')
  modules_rid_n_vul1 <- dbGetQuery(con,query_vul)
  modules_rid_n_no_vul1 <- dbGetQuery(con,query_no_vul)
  dbDisconnect(con)
  
  for (table in modules_rid_n) {
    query_vul <- paste("select xd.",metric," from (
                       SELECT DISTINCT tb.FilePath,tb.NameMethod,tb.AltCountLineCode,
                       tb.CountInput,tb.CountLineBlank,tb.CountLineCodeDecl,
                       tb.CountLineComment,tb.CountLinePreprocessor,tb.CountPath,
                       tb.CountStmt,tb.CountStmtEmpty,tb.Cyclomatic,tb.CyclomaticStrict,
                       tb.Knots,tb.MinEssentialKnots,tb.RatioCommentToCode,
                       tb.AltCountLineComment,tb.CountLine,tb.CountLineCode,
                       tb.CountLineCodeExe,tb.CountLineInactive,tb.CountOutput,
                       tb.CountSemicolon,tb.CountStmtDecl,tb.CountStmtExe,
                       tb.CyclomaticModified,tb.Essential,tb.MaxEssentialKnots,
                       tb.MaxNesting FROM ",table," tb where Patched=1 and Occurrence='before'
    ) xd;",sep="")
    query_no_vul <- paste("SELECT ",metric," FROM ",table," f2s WHERE f2s.ID_Function NOT IN (SELECT distinct tb.ID_Function FROM ",table," tb, (SELECT * FROM ",table," WHERE patched=1 AND Occurrence='before') vul WHERE tb.FilePath=vul.FilePath AND tb.NameMethod=vul.NameMethod AND tb.AltCountLineCode=vul.AltCountLineCode AND tb.CountInput=vul.CountInput AND tb.CountLineBlank=vul.CountLineBlank AND tb.CountLineCodeDecl=vul.CountLineCodeDecl AND tb.CountLineComment=vul.CountLineComment AND tb.CountLinePreprocessor=vul.CountLinePreprocessor AND tb.CountPath=vul.CountPath AND tb.CountStmt=vul.CountStmt AND tb.CountStmtEmpty=vul.CountStmtEmpty AND tb.Cyclomatic=vul.Cyclomatic AND tb.CyclomaticStrict=vul.CyclomaticStrict AND tb.Knots=vul.Knots AND tb.MinEssentialKnots=vul.MinEssentialKnots AND tb.RatioCommentToCode=vul.RatioCommentToCode AND tb.AltCountLineComment=vul.AltCountLineComment AND tb.CountLine=vul.CountLine AND tb.CountLineCode=vul.CountLineCode AND tb.CountLineCodeExe=vul.CountLineCodeExe AND tb.CountLineInactive=vul.CountLineInactive AND tb.CountOutput=vul.CountOutput AND tb.CountSemicolon=vul.CountSemicolon AND tb.CountStmtDecl=vul.CountStmtDecl AND tb.CountStmtExe=vul.CountStmtExe AND tb.CyclomaticModified=vul.CyclomaticModified AND tb.Essential=vul.Essential AND tb.MaxEssentialKnots=vul.MaxEssentialKnots AND tb.MaxNesting=vul.MaxNesting);",sep="")
    
    
    con <- dbConnect(MySQL(), user = 'root', password = 'admin', host = 'localhost', dbname='security')
    functions_vul <- dbGetQuery(con,query_vul)
    functions_no_vul <- dbGetQuery(con,query_no_vul)
    dbDisconnect(con)
    
    modules_rid_n_vul1 <- rbind(modules_rid_n_vul1,functions_vul)
    modules_rid_n_no_vul1 <- rbind(modules_rid_n_no_vul1,functions_no_vul)
  }
  
  v_m1 <- mean(modules_rid_n_vul1[,metric])
  s <- sd(modules_rid_n_vul1[,metric])
  se <- s / sqrt(length(modules_rid_n_vul1[,metric]))
  cv <- qt(0.975,df=length(modules_rid_n_vul1[,metric])-1)
  v_lower_ep1 <- v_m1 - cv*se
  v_upper_ep1 <- v_m1 + cv*se
  n_m1 <- mean(modules_rid_n_no_vul1[,metric])
  s <- sd(modules_rid_n_no_vul1[,metric])
  se <- s / sqrt(length(modules_rid_n_no_vul1[,metric]))
  cv <- qt(0.975,df=length(modules_rid_n_no_vul1[,metric])-1)
  n_lower_ep1 <- n_m1 - cv*se
  n_upper_ep1 <- n_m1 + cv*se
  
  print("~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~Pull Database R_ID=3~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~")
  modules_rid_n <- c("FUNCTIONS_3_driver_extra","FUNCTIONS_3_fs","FUNCTIONS_3_kernel","FUNCTIONS_3_linux","FUNCTIONS_3_net")
  
  table = "FUNCTIONS_3_arch"
  query_vul <- paste("select xd.",metric," from (
                     SELECT DISTINCT tb.FilePath,tb.NameMethod,tb.AltCountLineCode,
                     tb.CountInput,tb.CountLineBlank,tb.CountLineCodeDecl,
                     tb.CountLineComment,tb.CountLinePreprocessor,tb.CountPath,
                     tb.CountStmt,tb.CountStmtEmpty,tb.Cyclomatic,tb.CyclomaticStrict,
                     tb.Knots,tb.MinEssentialKnots,tb.RatioCommentToCode,
                     tb.AltCountLineComment,tb.CountLine,tb.CountLineCode,
                     tb.CountLineCodeExe,tb.CountLineInactive,tb.CountOutput,
                     tb.CountSemicolon,tb.CountStmtDecl,tb.CountStmtExe,
                     tb.CyclomaticModified,tb.Essential,tb.MaxEssentialKnots,
                     tb.MaxNesting FROM ",table," tb where Patched=1 and Occurrence='before'
  ) xd;",sep="")
  query_no_vul <- paste("SELECT ",metric," FROM ",table," f2s WHERE f2s.ID_Function NOT IN (SELECT distinct tb.ID_Function FROM ",table," tb, (SELECT * FROM ",table," WHERE patched=1 AND Occurrence='before') vul WHERE tb.FilePath=vul.FilePath AND tb.NameMethod=vul.NameMethod AND tb.AltCountLineCode=vul.AltCountLineCode AND tb.CountInput=vul.CountInput AND tb.CountLineBlank=vul.CountLineBlank AND tb.CountLineCodeDecl=vul.CountLineCodeDecl AND tb.CountLineComment=vul.CountLineComment AND tb.CountLinePreprocessor=vul.CountLinePreprocessor AND tb.CountPath=vul.CountPath AND tb.CountStmt=vul.CountStmt AND tb.CountStmtEmpty=vul.CountStmtEmpty AND tb.Cyclomatic=vul.Cyclomatic AND tb.CyclomaticStrict=vul.CyclomaticStrict AND tb.Knots=vul.Knots AND tb.MinEssentialKnots=vul.MinEssentialKnots AND tb.RatioCommentToCode=vul.RatioCommentToCode AND tb.AltCountLineComment=vul.AltCountLineComment AND tb.CountLine=vul.CountLine AND tb.CountLineCode=vul.CountLineCode AND tb.CountLineCodeExe=vul.CountLineCodeExe AND tb.CountLineInactive=vul.CountLineInactive AND tb.CountOutput=vul.CountOutput AND tb.CountSemicolon=vul.CountSemicolon AND tb.CountStmtDecl=vul.CountStmtDecl AND tb.CountStmtExe=vul.CountStmtExe AND tb.CyclomaticModified=vul.CyclomaticModified AND tb.Essential=vul.Essential AND tb.MaxEssentialKnots=vul.MaxEssentialKnots AND tb.MaxNesting=vul.MaxNesting);",sep="")
  
  con <- dbConnect(MySQL(), user = 'root', password = 'admin', host = 'localhost', dbname='security')
  modules_rid_n_vul3 <- dbGetQuery(con,query_vul)
  modules_rid_n_no_vul3 <- dbGetQuery(con,query_no_vul)
  dbDisconnect(con)
  
  for (table in modules_rid_n) {
    query_vul <- paste("select xd.",metric," from (
                       SELECT DISTINCT tb.FilePath,tb.NameMethod,tb.AltCountLineCode,
                       tb.CountInput,tb.CountLineBlank,tb.CountLineCodeDecl,
                       tb.CountLineComment,tb.CountLinePreprocessor,tb.CountPath,
                       tb.CountStmt,tb.CountStmtEmpty,tb.Cyclomatic,tb.CyclomaticStrict,
                       tb.Knots,tb.MinEssentialKnots,tb.RatioCommentToCode,
                       tb.AltCountLineComment,tb.CountLine,tb.CountLineCode,
                       tb.CountLineCodeExe,tb.CountLineInactive,tb.CountOutput,
                       tb.CountSemicolon,tb.CountStmtDecl,tb.CountStmtExe,
                       tb.CyclomaticModified,tb.Essential,tb.MaxEssentialKnots,
                       tb.MaxNesting FROM ",table," tb where Patched=1 and Occurrence='before'
    ) xd;",sep="")
    query_no_vul <- paste("SELECT ",metric," FROM ",table," f2s WHERE f2s.ID_Function NOT IN (SELECT distinct tb.ID_Function FROM ",table," tb, (SELECT * FROM ",table," WHERE patched=1 AND Occurrence='before') vul WHERE tb.FilePath=vul.FilePath AND tb.NameMethod=vul.NameMethod AND tb.AltCountLineCode=vul.AltCountLineCode AND tb.CountInput=vul.CountInput AND tb.CountLineBlank=vul.CountLineBlank AND tb.CountLineCodeDecl=vul.CountLineCodeDecl AND tb.CountLineComment=vul.CountLineComment AND tb.CountLinePreprocessor=vul.CountLinePreprocessor AND tb.CountPath=vul.CountPath AND tb.CountStmt=vul.CountStmt AND tb.CountStmtEmpty=vul.CountStmtEmpty AND tb.Cyclomatic=vul.Cyclomatic AND tb.CyclomaticStrict=vul.CyclomaticStrict AND tb.Knots=vul.Knots AND tb.MinEssentialKnots=vul.MinEssentialKnots AND tb.RatioCommentToCode=vul.RatioCommentToCode AND tb.AltCountLineComment=vul.AltCountLineComment AND tb.CountLine=vul.CountLine AND tb.CountLineCode=vul.CountLineCode AND tb.CountLineCodeExe=vul.CountLineCodeExe AND tb.CountLineInactive=vul.CountLineInactive AND tb.CountOutput=vul.CountOutput AND tb.CountSemicolon=vul.CountSemicolon AND tb.CountStmtDecl=vul.CountStmtDecl AND tb.CountStmtExe=vul.CountStmtExe AND tb.CyclomaticModified=vul.CyclomaticModified AND tb.Essential=vul.Essential AND tb.MaxEssentialKnots=vul.MaxEssentialKnots AND tb.MaxNesting=vul.MaxNesting);",sep="")
    
    
    con <- dbConnect(MySQL(), user = 'root', password = 'admin', host = 'localhost', dbname='security')
    functions_vul <- dbGetQuery(con,query_vul)
    functions_no_vul <- dbGetQuery(con,query_no_vul)
    dbDisconnect(con)
    
    modules_rid_n_vul3 <- rbind(modules_rid_n_vul3,functions_vul)
    modules_rid_n_no_vul3 <- rbind(modules_rid_n_no_vul3,functions_no_vul)
  }
  
  v_m3 <- mean(modules_rid_n_vul3[,metric])
  s <- sd(modules_rid_n_vul3[,metric])
  se <- s / sqrt(length(modules_rid_n_vul3[,metric]))
  cv <- qt(0.975,df=length(modules_rid_n_vul3[,metric])-1)
  v_lower_ep3 <- v_m3 - cv*se
  v_upper_ep3 <- v_m3 + cv*se
  n_m3 <- mean(modules_rid_n_no_vul3[,metric])
  s <- sd(modules_rid_n_no_vul3[,metric])
  se <- s / sqrt(length(modules_rid_n_no_vul3[,metric]))
  cv <- qt(0.975,df=length(modules_rid_n_no_vul3[,metric])-1)
  n_lower_ep3 <- n_m3 - cv*se
  n_upper_ep3 <- n_m3 + cv*se
  
  
  title=paste(metric,"ci", sep="_")
  path_image=paste("/home/rique/Temp_Graf_R/",title,".pdf",sep="")
  pdf(path_image)#,width = 390, height = 290
  
  x <- data.frame(lower_ep=c(v_lower_ep1,n_lower_ep1,v_lower_ep3,n_lower_ep3,v_lower_ep4,n_lower_ep4,v_lower_ep6,n_lower_ep6,v_lower_ep7,n_lower_ep7),upper_ep=c(v_upper_ep1,n_upper_ep1,v_upper_ep3,n_upper_ep3,v_upper_ep4,n_upper_ep4,v_upper_ep6,n_upper_ep6,v_upper_ep7,n_upper_ep7))
  
  textra<-(max(x$upper_ep)-min(x$lower_ep))/4
  ylegend<-c(min(x$lower_ep)-textra,max(x$upper_ep)+textra)
  xtam = c(1,5)
  
  plotCI(x=1,xaxt="n",xlab="",cex.lab=1.4,col="darkgrey",ylab="",y=v_m1,li=v_lower_ep1,ui=v_upper_ep1,ylim=ylegend,lwd=3,xlim=xtam,cex.axis=1.4)
  
  #abline(h = mean(modules_rid_n_vul1[,metric], na.rm = T), lty = 2)
  
  par(new=TRUE)
  
  plotCI(x=1,y=n_m1,li=n_lower_ep1,ui=n_upper_ep1,ylim=ylegend,lwd=3, axes=FALSE, ann=FALSE,xlim=xtam)
  #abline(h = mean(modules_rid_n_no_vul1[,metric], na.rm = T), lty = 2)
  
  par(new=TRUE)
  
  plotCI(col="darkgrey",x=2,y=v_m3,li=v_lower_ep3,ui=v_upper_ep3,ylim=ylegend,lwd=3, axes=FALSE, ann=FALSE,xlim=xtam)
  #abline(h = mean(modules_rid_n_vul2[,metric], na.rm = T), lty = 2)
  
  par(new=TRUE)
  
  plotCI(x=2,y=n_m3,li=n_lower_ep3,ui=n_upper_ep3,ylim=ylegend,lwd=3, axes=FALSE, ann=FALSE,xlim=xtam)
  #abline(h = mean(modules_rid_n_no_vul2[,metric], na.rm = T), lty = 2)
  
  par(new=TRUE)
  
  plotCI(col="darkgrey",x=3,y=v_m4,li=v_lower_ep4,ui=v_upper_ep4,ylim=ylegend,lwd=3, axes=FALSE, ann=FALSE,xlim=xtam)
  #abline(h = mean(modules_rid_n_vul3[,metric], na.rm = T), lty = 2)
  
  par(new=TRUE)
  
  plotCI(x=3,y=n_m4,li=n_lower_ep4,ui=n_upper_ep4,ylim=ylegend,lwd=3, axes=FALSE, ann=FALSE,xlim=xtam)
  #abline(h = mean(modules_rid_n_no_vul3[,metric], na.rm = T), lty = 2)
  
  par(new=TRUE)
  
  plotCI(col="darkgrey",x=4,y=v_m6,li=v_lower_ep6,ui=v_upper_ep6,ylim=ylegend,lwd=3, axes=FALSE, ann=FALSE,xlim=xtam)
  #abline(h = mean(modules_rid_n_vul4[,metric], na.rm = T), lty = 2)
  
  par(new=TRUE)
  
  plotCI(x=4,y=n_m6,li=n_lower_ep6,ui=n_upper_ep6,ylim=ylegend,lwd=3, axes=FALSE, ann=FALSE,xlim=xtam)
  #abline(h = mean(modules_rid_n_no_vul4[,metric], na.rm = T), lty = 2)
  
  par(new=TRUE)
  
  plotCI(col="darkgrey",x=5,y=v_m7,li=v_lower_ep7,ui=v_upper_ep7,ylim=ylegend,lwd=3, axes=FALSE, ann=FALSE,xlim=xtam)
  #abline(h = mean(modules_rid_n_vul4[,metric], na.rm = T), lty = 2)
  
  par(new=TRUE)
  
  plotCI(x=5,y=n_m7,li=n_lower_ep7,ui=n_upper_ep7,ylim=ylegend,lwd=3, axes=FALSE, ann=FALSE,xlim=xtam)
  #abline(h = mean(modules_rid_n_no_vul4[,metric], na.rm = T), lty = 2)
  
  #axis(2)
  axis(side=1, at=c(1,2,3,4,5), labels=c("Mozilla", "Linux", "Xen", "Httpd", "Glibc"),cex.axis=1.4)
  
  #legend("topright", legend="mean", lty=2, lwd=0.5, bty="n")
  legend("topleft", xpd=TRUE, ncol=2, legend=c("V", "N"),
         fill=c("grey", "black"), bty="n",cex=1.5)
  
  grid()
  dev.off()
  
  title=paste(metric,"boxplot", sep="_")
  path_image=paste("/home/rique/Temp_Graf_R/",title,".pdf",sep="")
  pdf(path_image)
  
  #colnames(modules_rid_n_vul1)=c('m14 v')
  #colnames(modules_rid_n_vul2)=c('m08 v')
  #colnames(modules_rid_n_vul3)=c('k v')
  #colnames(modules_rid_n_vul4)=c('xen v')
  #colnames(modules_rid_n_no_vul1)=c('m14 no')
  #colnames(modules_rid_n_no_vul2)=c('m08 no')
  #colnames(modules_rid_n_no_vul3)=c('k no')
  #colnames(modules_rid_n_no_vul4)=c('xen no')
  
  dados<-c(modules_rid_n_vul1,modules_rid_n_no_vul1,modules_rid_n_vul3,modules_rid_n_no_vul3,modules_rid_n_vul4,modules_rid_n_no_vul4,modules_rid_n_vul6,modules_rid_n_no_vul6,modules_rid_n_vul7,modules_rid_n_no_vul7);
  boxplot(cex.axis=1.4,cex.lab=1.4,dados,outline=FALSE,names = c("V","N","V","N","V","N","V","N","V","N"),xlab="Mozilla      Kernel     Xen HV     Httpd        Glibc")
  #axis(side=1, at=c(1,3,5,7,9), labels=c("Mozilla", "Linux", "Xen", "Httpd", "Glibc"),cex.axis=1.5)
  
  #mtext("legenda no lado errado", side=4, line=1, at=20,cex=2, family="serif")
  #text(0.5,1,"texto")
  #boxplot(dados,outline=FALSE,at =c(1,2, 4,5, 7,8, 10,11),las = 2
  
  dev.off()
  
}