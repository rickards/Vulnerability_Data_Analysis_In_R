library(RMySQL)
library(caret)
require(randomForest)
library(ipred)
#library(doMC)

rfRFE <-  list(summary = defaultSummary,
               fit = function(x, y, first, last, ...){
                 library(randomForest)
                 randomForest(x, y, importance = first, ntree=10, ...)
               },
               pred = function(object, x)  predict(object, x),
               rank = function(object, x, y) {
                 vimp <- varImp(object)
                 vimp <- vimp[order(vimp$Overall,decreasing = TRUE),,drop = FALSE]
                 vimp$var <- rownames(vimp)                  
                 vimp
               },
               selectSize = pickSizeBest,
               selectVar = pickVars)

projects<-c('glibc','httpd','xen','derby','tomcat','kernel','mozilla')

path<-"/home/rique/Temp_Results_R/importance/"
dir.create(path,recursive = TRUE)
setwd(path)

metrics <- c("CountLine","CountLineCodeDecl","CountLineBlank","CountStmt","CountStmtDecl","CyclomaticStrict","MaxNesting","Knots","MaxEssentialKnots","CountPath","RatioCommentToCode","CountInput","CountOutput","Affected")

df <- NULL
for(project in projects){
  
  con <- dbConnect(MySQL(), user = 'root', password = 'admin', host = '127.0.0.1', dbname='software')
  temp <- dbGetQuery(con, paste("SELECT * FROM software.FUNCTIONS_neutral_",project,sep = ''))
  temp <- subset(temp, select = metrics)
  df <- rbind(df,temp)
  temp <- dbGetQuery(con, paste("SELECT * FROM software.FUNCTIONS_affected_",project,sep = ''))
  temp <- subset(temp, select = metrics)
  df <- rbind(df,temp)
  dbDisconnect(con)
  temp<-NULL
}

# SABER O NUMERO MINIMO DE ARVORES PARA EVITAR O MAIOR ERRO POSSÍVEL
cross.self.rf <- randomForest(Affected~., data=df, ntree = 15, importance = T)
pdf(paste(path,"number_tree_all_projects",".pdf",sep = ''))
plot(cross.self.rf)
dev.off()
importance <- varImp(cross.self.rf)
write.csv(importance, paste(path,"importance_all_projects",".csv",sep = ''))


# IMPORTANCIA DE TODAS AS MÉTRICAS
#fit=randomForest(Affected~., data=df, ntree=10, importance=TRUE)
#importance <- varImp(fit)
#write.csv(importance, paste(path,"importance_all_projects",".csv",sep = ''))

pdf(paste(path,"importance_all_projects",".pdf",sep = ''))
varImpPlot(cross.self.rf)
dev.off()

#registerDoMC(cores = 4)

#RFE
#df$Affected <- factor(ifelse(df$Affected == 0,"NEUTRAL","VULNERABLE"))
# define the control using a random forest selection function
control <- rfeControl(functions=rfRFE, method="cv", number=10, verbose = TRUE)
# run the RFE algorithm
results <- rfe(df[,1:13], df[,14], sizes=c(1:13), rfeControl=control)
# summarize the results
print(results)
# list the chosen features
predictors(results)
# plot the results
pdf(paste(path,"rfe_all_projects",".pdf",sep = ''))
plot(results, type=c("g", "o"))
dev.off()

