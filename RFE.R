library(RMySQL)
library(caret)
require(randomForest)
library(ipred)
library(doMC)

projects<-c('glibc','httpd','xen','derby','tomcat','kernel','mozilla')

path<-"/home/rique/Temp_Results_R/importance/"
dir.create(path,recursive = TRUE)
setwd(path)

metrics <- c("CountLine","CountLineCodeDecl","CountLineBlank","CountStmt","CountStmtDecl","CyclomaticStrict","MaxNesting","Knots","MaxEssentialKnots","CountPath","RatioCommentToCode","CountInput","CountOutput","Affected")

df <- NULL
for(project in projects){
  
  con <- dbConnect(MySQL(), user = 'root', password = 'admin', host = '127.0.0.1', dbname='software')
  temp <- dbGetQuery(con, paste("SELECT * FROM software.FUNCTIONS_neutral_",project,sep = ''))
  temp <- subset(temp, select = metrics)
  df <- rbind(df,temp)
  temp <- dbGetQuery(con, paste("SELECT * FROM software.FUNCTIONS_affected_",project,sep = ''))
  temp <- subset(temp, select = metrics)
  df <- rbind(df,temp)
  dbDisconnect(con)
  
}

fit=randomForest(Affected~., data=df, ntree=10, importance=TRUE)
importance <- varImp(fit)
write.csv(importance, paste(path,"importance_all_projects",".csv",sep = ''))

pdf(paste(path,"importance_all_projects",".pdf",sep = ''))
varImpPlot(fit)
dev.off()

registerDoMC(cores = 4)
#RFE
df$Affected <- factor(ifelse(df$Affected == 0,"NEUTRAL","VULNERABLE"))
# define the control using a random forest selection function
control <- rfeControl(functions=nbFuncs, method="cv", number=10, verbose = TRUE)
# run the RFE algorithm
results <- rfe(df[,1:13], df[,14], sizes=c(1:13), rfeControl=control)
# summarize the results
print(results)
# list the chosen features
predictors(results)
# plot the results
plot(results, type=c("g", "o"))