library(RMySQL)
library(caret)
require(randomForest)

projects<-c('glibc','httpd','xen','derby','tomcat','kernel','mozilla')

path<-"/home/rique/Temp_Results_R/cap6/importance.r/"
dir.create(path,recursive = TRUE)
setwd(path)

metrics <- c("CountLine","CountLineCode","CountLineCodeExe","CountLineCodeDecl","CountLineBlank","CountStmt","CountStmtExe","CountStmtDecl","Cyclomatic","CyclomaticModified","CyclomaticStrict","CountSemicolon","MaxNesting","Knots","Essential","MaxEssentialKnots","MinEssentialKnots","CountPath","CountLineComment","RatioCommentToCode","CountInput","CountOutput","Affected")
#metrics <- c("CountLine", "CountStmt", "CyclomaticStrict", "MaxEssencialKnots", "RatioCommentToCode,CountLineCodeDecl", "CountLineBlank", "CountStmtDecl", "MaxNesting", "Knots", "CountPath", "CountInput", "CountOutput", "Affected")

fits <- data.frame(row.names = c(1:20))
output <- data.frame(row.names = data.frame(metrics)[1:22,])
for(project in projects){
  print(project)
  
  con <- dbConnect(MySQL(), user = 'root', password = 'admin', host = '127.0.0.1', dbname='software')
  df <- dbGetQuery(con, paste("SELECT * FROM software.FUNCTIONS_neutral_",project,sep = ''))
  df <- rbind(df,dbGetQuery(con, paste("SELECT * FROM software.FUNCTIONS_affected_",project,sep = '')))
  df <- subset(df, select = metrics)
  #eliminando duplicados
  only_metrics <- df
  only_metrics$Affected <- NULL
  df <- df[!duplicated(only_metrics),]
  only_metrics<-NULL
  dbDisconnect(con)
  
  fit=randomForest(Affected~., data=df, ntree=20, importance=TRUE)
  fits[,project] <- fit$mse
  importance <- varImp(fit)
  
  #df$Affected <- factor(ifelse(df$Affected == 0,"NEUTRAL","VULNERABLE"))
  #control <- trainControl(method="repeatedcv", number=10, repeats=3)
  #model <- train(Affected~.,data=df, method="lvq", preProcess="scale", trControl=control, na.action = na.pass)
  #importance <- varImp(model, scale=FALSE)

  output[,project] <- importance$Overall
}


output$total <- output$glibc+output$httpd+output$xen+output$derby+output$tomcat+output$kernel+output$mozilla
write.csv(output, paste(path,"importance_each_project",".csv",sep = ''))


pdf(paste(path,"number_tree_projects",".pdf",sep = ''))

all <- c(fits$glibc,fits$httpd,fits$xen)
plot(fits$mozilla, type="l", ylab = "Erro", xlab = "Árvores", xlim = c(0,20), ylim = c(min(all),max(all)), col = "blue")
par(new=TRUE)
plot(fits$kernel, type="l", ylab = "Erro", xlab = "Árvores", xlim = c(0,20), ylim = c(min(all),max(all)), axes=FALSE, ann=FALSE, col = "black")
par(new=TRUE)
plot(fits$xen, type="l", ylab = "Erro", xlab = "Árvores", xlim = c(0,20), ylim = c(min(all),max(all)), axes=FALSE, ann=FALSE, col = "red")
par(new=TRUE)
plot(fits$httpd, type="l", ylab = "Erro", xlab = "Árvores", xlim = c(0,20), ylim = c(min(all),max(all)), axes=FALSE, ann=FALSE, col = "grey")
par(new=TRUE)
plot(fits$glibc, type="l", ylab = "Erro", xlab = "Árvores", xlim = c(0,20), ylim = c(min(all),max(all)), axes=FALSE, ann=FALSE, col = "darkgoldenrod1")
par(new=TRUE)
plot(fits$tomcat, type="l", ylab = "Erro", xlab = "Árvores", xlim = c(0,20), ylim = c(min(all),max(all)), axes=FALSE, ann=FALSE, col = "cyan3")
par(new=TRUE)
plot(fits$derby, type="l", ylab = "Erro", xlab = "Árvores", xlim = c(0,20), ylim = c(min(all),max(all)), axes=FALSE, ann=FALSE, col = "darkmagenta")

legend("topright", xpd=TRUE, ncol=2, legend=c("Mzl","Ker","Xen","Htt","Glc","Deb","Tct"),
       fill=c("blue","black","red","grey","darkgoldenrod1","cyan3","darkmagenta"), bty="n",cex=1.0)

dev.off()
