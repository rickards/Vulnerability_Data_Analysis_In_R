library(RMySQL)
library(plotrix)
library(xtable)

correlacao <- function(tables,metrics,title)
{
  df <- NULL
  for (table in tables){
    print(paste(title,table,sep = "->"))
    con <- dbConnect(MySQL(), user = 'root', password = 'admin', host = 'localhost', dbname='software')
    
    query <- "SELECT SUM(Affected) AS numVuln"
    for (metric in metrics) {
      query <- paste(query,",AVG(",metric,")",sep = "")
    }
    query <- paste(query," FROM software.",table," where Affected=1 GROUP BY NameMethod,FilePath ORDER BY numVuln;", sep = "")
    print(query)
    
    df <- rbind(df,dbGetQuery(con,query))
    
    dbDisconnect(con)
  }
  
  temp <- cor(df,df[,'numVuln'], method="spearman")
  temp[0,1] <- title
  return(temp)
}

metrics <- c("CountInput","CountLine","CountLineBlank","CountLineCode","CountLineCodeDecl","CountLineCodeExe","CountLineComment","CountOutput","CountPath","CountSemicolon","CountStmt","CountStmtDecl","CountStmtExe","Cyclomatic","CyclomaticModified","CyclomaticStrict","Essential","Knots","MaxEssentialKnots","MaxNesting","MinEssentialKnots","RatioCommentToCode")
output <- NULL

modules <- c("FUNCTIONS_affected_mozilla")
output <- correlacao(modules,metrics,"mozilla")

modules <- c("FUNCTIONS_affected_kernel")
output <- cbind(output,correlacao(modules,metrics,"kernel"))

modules <- c("FUNCTIONS_affected_xen")
output <- cbind(output,correlacao(modules,metrics,"xen"))

modules <- c("FUNCTIONS_affected_httpd")
output <- cbind(output,correlacao(modules,metrics,"httpd"))

modules <- c("FUNCTIONS_affected_glibc")
output <- cbind(output,correlacao(modules,metrics,"glibc"))

modules <- c("FUNCTIONS_affected_tomcat")
output <- cbind(output,correlacao(modules,metrics,"tomcat"))

modules <- c("FUNCTIONS_affected_derby")
output <- cbind(output,correlacao(modules,metrics,"derby"))

modules <- c("FUNCTIONS_affected_mozilla","FUNCTIONS_affected_kernel","FUNCTIONS_affected_xen","FUNCTIONS_affected_httpd","FUNCTIONS_affected_glibc","FUNCTIONS_affected_tomcat","FUNCTIONS_affected_derby")
output <- cbind(output,correlacao(modules,metrics,"all"))

write.csv(output, paste("~/Temp_Graf_R/","correlation_numberVuln_Function_spearman",".csv",sep = ''))
