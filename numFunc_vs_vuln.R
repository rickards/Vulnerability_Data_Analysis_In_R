library(RMySQL)
library(plotrix)

funcao <- function(modules,title)
{
  together_v <- NULL
  together_n <- NULL
  query_vul <- "SELECT MAX(numVuln) as M,COUNT(numVuln) from (SELECT SUM(Affected) as numVuln FROM ("
  for (table in modules){
    query_vul <- paste(query_vul,"select Affected,NameMethod,FilePath from ",table," union all ",sep = "")
  }
  query_vul <- paste(query_vul,"select Affected,NameMethod,FilePath from FUNCTIONS) as y where y.Affected=1 group by NameMethod,y.FilePath) as t group by t.numVuln order by M;",sep = "")
  print(query_vul)
  con <- dbConnect(MySQL(), user = 'root', password = 'admin', host = '127.0.0.1', dbname='software')
    
  functions_vul <- dbGetQuery(con,query_vul)
  
  dbDisconnect(con)
  
  path_image=paste("~/Temp_Graf_R/",title,".pdf",sep="")
  pdf(path_image)
  
  X1<-NULL
  cont<-0
  for (inc in functions_vul[,'M']) {
    cont<-cont+1
    if(cont<11){
      X1<-rbind(X1,inc)
    }
    if(cont==10){
      X1<-rbind(X1,paste(">",inc,sep = ""))
    }
  }
    
  X2<-NULL
  maior10<-0
  cont<-0
  for (inc in functions_vul[,'COUNT(numVuln)']) {
    cont<-cont+1
    if(cont<11){
      X2<-rbind(X2,inc)
    }
    if(cont>10){
      maior10<-maior10+inc
    }
  }
  X2<-rbind(X2,maior10)
  
  #X1<-c(1,2,3,4,5,6,7,8,9,10,'>10')
  #X2<-c(5478,1385,361,257,84,100,19,35,14,17,40)
  bp <- barplot(X2[,1],ylab="Number of Functions", xlab="Number of Vulnerabilities",names.arg=X1[,1],
                #ylim = c(1,max(X2[,1])+(max(X2[,1]))/10),
                ylim = c(0,2000),
                cex.axis = 1.2,
                cex.names = 1.2
                #,log="y"
                )
  text(bp,X2,X2,col="blue",pos=3)
  dev.off()
}

modules <- c("FUNCTIONS_affected_mozilla","FUNCTIONS_affected_kernel","FUNCTIONS_affected_xen","FUNCTIONS_affected_httpd","FUNCTIONS_affected_glibc","FUNCTIONS_affected_tomcat","FUNCTIONS_affected_derby")
funcao(modules,"numFunc_vs_vuln")